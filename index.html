<!DOCTYPE html>
<html lang="fa">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>نمایش ویدیوی دوربین</title>
  </head>
  <body>
    <video style="display: none" id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>
    <script>
      const video = document.querySelector("video");
      const canvas = document.querySelector("canvas");
      const context = canvas.getContext("2d");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      // دسترسی به دوربین و نمایش در ویدیو
      let oldPixels = [];
      let pos = [];
      let audio = new Audio();
      audio.src = "646fa044ccb4e.mp3";

      let squareTarget = "";
      navigator.mediaDevices
        .getUserMedia({ video: true })
        .then((stream) => {
          video.srcObject = stream;
          video.play();
        })
        .catch((error) => {
          console.error("خطا در دسترسی به دوربین:", error);
        });

      // کپی کردن ویدیو به canvas
      function draw() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        requestAnimationFrame(draw);
        pos.forEach((item, inde) => {
          if (!item.toX) return;
          context.strokeStyle = "red";
          context.strokeRect(
            item.fromX,
            item.fromY,
            item.toX - item.fromX,
            item.toY - item.fromY
          );
        });
        if (pos.length < 4) return;
        pos.forEach((item, inde) => {
          const imageData = context.getImageData(
            item.fromX,
            item.fromY,
            item.toX - item.fromX,
            item.toY - item.fromY
          );

          const pixels = imageData.data; // آرایه‌ای از مقادیر RGBA
          let index = Math.floor(pixels.length / 2);
          if (audio.currentTime > 3) {
            audio.pause();
            audio.currentTime = 0;
          }
          if (oldPixels.length > 0&&oldPixels[inde]) {
            
            if (pixels[index] - oldPixels[inde][index] > 10) audio.play();
          }
          if (!oldPixels[inde]) oldPixels.push(pixels);
          else oldPixels[inde] = pixels;
        });
      }
      draw();
      let indexOfCurrentPos = 0;
      canvas.addEventListener("click", (e) => {
        console.log(e.clientX, e.clientY);
        if (!pos[indexOfCurrentPos])
          pos[indexOfCurrentPos] = {
            fromX: "",
            fromY: "",
            toX: "",
            toY: "",
          };
        if (!pos[indexOfCurrentPos]["fromX"]) {
          pos[indexOfCurrentPos]["fromX"] = e.clientX;
          pos[indexOfCurrentPos]["fromY"] = e.clientY;
          return;
        } else if (!pos[indexOfCurrentPos]["toX"]) {
          pos[indexOfCurrentPos]["toX"] = e.clientX;
          pos[indexOfCurrentPos]["toY"] = e.clientY;
        }
        console.log(pos[indexOfCurrentPos]);
        indexOfCurrentPos++;
        video.addEventListener("loadedmetadata", () => {
          draw();
        });
      });
    </script>
  </body>
</html>
